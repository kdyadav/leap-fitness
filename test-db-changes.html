<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Database Changes</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      h2 {
        color: #666;
        border-bottom: 2px solid #4f46e5;
        padding-bottom: 10px;
      }
      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
      }
      .status.success {
        background: #10b981;
        color: white;
      }
      .status.error {
        background: #ef4444;
        color: white;
      }
      .status.info {
        background: #3b82f6;
        color: white;
      }
      .workout-card {
        border: 1px solid #e5e7eb;
        padding: 15px;
        margin: 10px 0;
        border-radius: 6px;
        background: #f9fafb;
      }
      .exercise-item {
        padding: 8px;
        margin: 5px 0;
        background: white;
        border-left: 3px solid #4f46e5;
        padding-left: 12px;
      }
      button {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background: #4338ca;
      }
      .equipment-tag {
        display: inline-block;
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin: 2px;
      }
      pre {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Database Changes Test Suite</h1>

    <div class="test-section">
      <h2>Test Controls</h2>
      <button onclick="runTests()">‚ñ∂Ô∏è Run All Tests</button>
      <button onclick="clearDB()">üóëÔ∏è Clear Database</button>
      <button onclick="resetDB()">üîÑ Reset & Seed Database</button>
    </div>

    <div id="results"></div>

    <script type="module">
      import { seedDatabase } from "./src/services/seedDatabase.js";
      import { workoutService } from "./src/services/db.js";
      import {
        getAllExercises,
        getExerciseById,
        getWorkoutWithExercises,
        workoutsData,
      } from "./src/data/workouts.js";
      import db from "./src/services/db.js";

      window.seedDatabase = seedDatabase;
      window.workoutService = workoutService;
      window.getAllExercises = getAllExercises;
      window.getExerciseById = getExerciseById;
      window.getWorkoutWithExercises = getWorkoutWithExercises;
      window.workoutsData = workoutsData;
      window.db = db;

      window.runTests = async function () {
        const results = document.getElementById("results");
        results.innerHTML =
          '<div class="test-section"><h2>Running Tests...</h2></div>';

        try {
          // Test 1: Check workoutsData structure
          await testWorkoutsDataStructure();

          // Test 2: Check helper functions
          await testHelperFunctions();

          // Test 3: Load workouts from database
          await testDatabaseWorkouts();

          // Test 4: Verify exercise details
          await testExerciseDetails();

          // Test 5: Verify equipment aggregation
          await testEquipmentAggregation();

          results.innerHTML +=
            '<div class="test-section"><h2 style="color: #10B981;">‚úÖ All Tests Completed!</h2></div>';
        } catch (error) {
          results.innerHTML += `<div class="test-section"><h2 style="color: #EF4444;">‚ùå Test Failed: ${error.message}</h2><pre>${error.stack}</pre></div>`;
        }
      };

      async function testWorkoutsDataStructure() {
        const results = document.getElementById("results");
        results.innerHTML +=
          '<div class="test-section"><h2>Test 1: WorkoutsData Structure</h2>';

        // Check that workoutsData has exercise IDs
        const workout1 = workoutsData[1];
        const isArrayOfStrings = workout1.exercises.every(
          (ex) => typeof ex === "string"
        );

        if (isArrayOfStrings && workout1.exercises[0].startsWith("ex")) {
          results.innerHTML +=
            '<p><span class="status success">PASS</span> Workout exercises are stored as IDs</p>';
          results.innerHTML += `<p>Sample: ${workout1.exercises
            .slice(0, 3)
            .join(", ")}...</p>`;
        } else {
          throw new Error("Workouts still contain full objects instead of IDs");
        }

        results.innerHTML += "</div>";
      }

      async function testHelperFunctions() {
        const results = document.getElementById("results");
        results.innerHTML +=
          '<div class="test-section"><h2>Test 2: Helper Functions</h2>';

        // Test getAllExercises
        const allExercises = getAllExercises();
        results.innerHTML += `<p><span class="status info">INFO</span> Total exercises in library: ${allExercises.length}</p>`;

        // Test getExerciseById
        const exercise = getExerciseById("ex1");
        if (exercise && exercise.name === "Push-ups") {
          results.innerHTML += `<p><span class="status success">PASS</span> getExerciseById works: ${exercise.name} (${exercise.equipment})</p>`;
        } else {
          throw new Error("getExerciseById failed");
        }

        // Test getWorkoutWithExercises
        const workoutWithExercises = getWorkoutWithExercises(1);
        if (workoutWithExercises && workoutWithExercises.exercises[0].name) {
          results.innerHTML += `<p><span class="status success">PASS</span> getWorkoutWithExercises works</p>`;
          results.innerHTML += `<p>First exercise: ${workoutWithExercises.exercises[0].name} (${workoutWithExercises.exercises[0].equipment})</p>`;
        } else {
          throw new Error("getWorkoutWithExercises failed");
        }

        results.innerHTML += "</div>";
      }

      async function testDatabaseWorkouts() {
        const results = document.getElementById("results");
        results.innerHTML +=
          '<div class="test-section"><h2>Test 3: Database Workouts</h2>';

        // Ensure DB is seeded
        const workoutCount = await db.default.workouts.count();
        if (workoutCount === 0) {
          results.innerHTML +=
            '<p><span class="status info">INFO</span> Database empty, seeding...</p>';
          await seedDatabase();
        }

        // Get workouts from database
        const workouts = await workoutService.getWorkouts();
        results.innerHTML += `<p><span class="status info">INFO</span> Loaded ${workouts.length} workouts from database</p>`;

        if (workouts.length > 0) {
          const workout = workouts[0];

          // Check that exercises are full objects
          if (workout.exercises && workout.exercises[0].name) {
            results.innerHTML += `<p><span class="status success">PASS</span> Workouts have full exercise objects</p>`;

            // Display sample workout
            results.innerHTML += `
                        <div class="workout-card">
                            <h3>${workout.icon} ${workout.name}</h3>
                            <p>Duration: ${workout.duration} min | Calories: ${
              workout.calories
            }</p>
                            <p><strong>Exercises (${
                              workout.exercises.length
                            }):</strong></p>
                            ${workout.exercises
                              .slice(0, 3)
                              .map(
                                (ex) => `
                                <div class="exercise-item">
                                    ${ex.icon} ${ex.name} - 
                                    ${
                                      ex.reps
                                        ? ex.reps + " reps"
                                        : ex.duration + " sec"
                                    } √ó ${ex.sets} sets
                                    ${
                                      ex.equipment
                                        ? '<span class="equipment-tag">' +
                                          ex.equipment +
                                          "</span>"
                                        : ""
                                    }
                                </div>
                            `
                              )
                              .join("")}
                            ${
                              workout.exercises.length > 3
                                ? `<p>... and ${
                                    workout.exercises.length - 3
                                  } more</p>`
                                : ""
                            }
                        </div>
                    `;
          } else {
            throw new Error("Workout exercises are not full objects");
          }
        }

        results.innerHTML += "</div>";
      }

      async function testExerciseDetails() {
        const results = document.getElementById("results");
        results.innerHTML +=
          '<div class="test-section"><h2>Test 4: Exercise Details</h2>';

        const workout = await workoutService.getWorkout(1);

        // Check that all exercises have required fields
        const hasAllFields = workout.exercises.every(
          (ex) =>
            ex.name &&
            ex.icon &&
            ex.category &&
            ex.equipment !== undefined &&
            (ex.reps || ex.duration) &&
            ex.sets
        );

        if (hasAllFields) {
          results.innerHTML +=
            '<p><span class="status success">PASS</span> All exercises have complete data</p>';

          // Show equipment diversity
          const equipmentTypes = [
            ...new Set(workout.exercises.map((ex) => ex.equipment)),
          ];
          results.innerHTML += `<p>Equipment types in workout: ${equipmentTypes
            .map((eq) => '<span class="equipment-tag">' + eq + "</span>")
            .join(" ")}</p>`;
        } else {
          throw new Error("Some exercises missing required fields");
        }

        results.innerHTML += "</div>";
      }

      async function testEquipmentAggregation() {
        const results = document.getElementById("results");
        results.innerHTML +=
          '<div class="test-section"><h2>Test 5: Equipment Aggregation</h2>';

        const workout = await workoutService.getWorkout(1);

        if (workout.equipment && Array.isArray(workout.equipment)) {
          results.innerHTML += `<p><span class="status success">PASS</span> Workout has equipment list</p>`;
          results.innerHTML += `<p>Equipment needed: ${
            workout.equipment.length > 0
              ? workout.equipment
                  .map((eq) => '<span class="equipment-tag">' + eq + "</span>")
                  .join(" ")
              : '<span class="equipment-tag">None (Bodyweight)</span>'
          }</p>`;
        } else {
          results.innerHTML +=
            '<p><span class="status info">INFO</span> Equipment aggregation not present (optional feature)</p>';
        }

        results.innerHTML += "</div>";
      }

      window.clearDB = async function () {
        if (confirm("Are you sure you want to clear the database?")) {
          await db.default.delete();
          await db.default.open();
          document.getElementById("results").innerHTML =
            '<div class="test-section"><h2>‚úÖ Database Cleared</h2></div>';
        }
      };

      window.resetDB = async function () {
        await db.default.delete();
        await db.default.open();
        await seedDatabase();
        document.getElementById("results").innerHTML =
          '<div class="test-section"><h2>‚úÖ Database Reset and Seeded</h2></div>';
      };
    </script>
  </body>
</html>
